# Complete FFmpeg + Environment Configuration
packages:
  yum:
    git: []
    wget: []

files:
  "/tmp/ffmpeg-release-amd64-static.tar.xz":
    mode: "000644"
    owner: root
    group: root
    source: https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz

commands:
  01_update_system:
    command: "yum update -y"
    ignoreErrors: true
  
  02_extract_ffmpeg:
    command: "cd /tmp && tar -xf ffmpeg-release-amd64-static.tar.xz"
    ignoreErrors: true
  
  03_copy_ffmpeg:
    command: "cp /tmp/ffmpeg-*-amd64-static/ffmpeg /usr/local/bin/"
    ignoreErrors: true
  
  04_copy_ffprobe:
    command: "cp /tmp/ffmpeg-*-amd64-static/ffprobe /usr/local/bin/"
    ignoreErrors: true
  
  05_make_executable:
    command: "chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe"
    ignoreErrors: true
  
  06_create_symlinks:
    command: "ln -sf /usr/local/bin/ffmpeg /usr/bin/ffmpeg && ln -sf /usr/local/bin/ffprobe /usr/bin/ffprobe"
    ignoreErrors: true
  
  07_verify_installation:
    command: "ffmpeg -version > /tmp/ffmpeg_install_log.txt 2>&1"
    ignoreErrors: true
  
  08_cleanup:
    command: "rm -rf /tmp/ffmpeg-*"
    ignoreErrors: true

option_settings:
  # Environment Variables
  aws:elasticbeanstalk:application:environment:
    FFMPEG_PATH: "/usr/local/bin/ffmpeg"
    FFPROBE_PATH: "/usr/local/bin/ffprobe"
    PATH: "/usr/local/bin:$PATH"
  
  # Python Configuration
  aws:elasticbeanstalk:container:python:
    WSGIPath: "application.py"
  
  # Health Check Configuration
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: "/health"
  
  # Auto Scaling Configuration
  aws:autoscaling:asg:
    HealthCheckType: ELB
    HealthCheckGracePeriod: 300
  
  # Load Balancer Configuration
  aws:elasticbeanstalk:environment:
    LoadBalancerType: application
  
  # Instance Configuration
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.small
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role

# Optional: Container Commands (run after application deployment)
container_commands:
  01_test_ffmpeg:
    command: "ffmpeg -version"
    ignoreErrors: true
  
  02_create_temp_dirs:
    command: "mkdir -p /tmp/uploads /tmp/processed"
    ignoreErrors: true
  
  03_set_permissions:
    command: "chmod 777 /tmp/uploads /tmp/processed"
    ignoreErrors: true
