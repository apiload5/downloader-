option_settings:
  # Launch Template Configuration
  aws:autoscaling:launchconfiguration:
    RootVolumeType: gp3
    DisableIMDSv1: true
    RootVolumeSize: 30  # Increased for video files
  
  # Instance Configuration (Upgraded for video processing)
  aws:ec2:instances:
    InstanceTypes: t3.medium  # Better performance for video processing
  
  # Python Configuration
  aws:elasticbeanstalk:container:python:
    WSGIPath: application.py
  
  # Environment Variables
  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: "/var/app/current"
    PYTHONUNBUFFERED: "1"
    FFMPEG_PATH: "/usr/local/bin/ffmpeg"
    FFPROBE_PATH: "/usr/local/bin/ffprobe"
  
  # Health Check
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: "/health"
  
  # Timeout Settings (Increased for video processing)
  aws:elasticbeanstalk:command:
    Timeout: 3600  # 1 hour for large video downloads

# System packages
packages:
  yum:
    git: []
    wget: []
    python3-devel: []
    gcc: []

# FFmpeg Installation
files:
  "/tmp/ffmpeg-release-amd64-static.tar.xz":
    mode: "000644"
    owner: root
    group: root
    source: https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz

commands:
  01_update_system:
    command: "yum update -y"
    ignoreErrors: true
  
  02_extract_ffmpeg:
    command: "cd /tmp && tar -xf ffmpeg-release-amd64-static.tar.xz"
    ignoreErrors: true
  
  03_install_ffmpeg:
    command: |
      cd /tmp
      cp ffmpeg-*-amd64-static/ffmpeg /usr/local/bin/
      cp ffmpeg-*-amd64-static/ffprobe /usr/local/bin/
      chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe
      ln -sf /usr/local/bin/ffmpeg /usr/bin/ffmpeg
      ln -sf /usr/local/bin/ffprobe /usr/bin/ffprobe
    ignoreErrors: true
  
  04_create_directories:
    command: |
      mkdir -p /tmp/downloads /tmp/processing
      chmod 777 /tmp/downloads /tmp/processing
    ignoreErrors: true
  
  05_verify_ffmpeg:
    command: "ffmpeg -version > /tmp/ffmpeg_install_log.txt 2>&1"
    ignoreErrors: true
  
  06_cleanup:
    command: "rm -rf /tmp/ffmpeg-*"
    ignoreErrors: true

# Auto Scaling Configuration
Resources:
  AWSEBAutoScalingGroup:
    Type: "AWS::AutoScaling::AutoScaling Group"
    Properties:
      HealthCheckType: ELB
      HealthCheckGracePeriod: 1200  # 20 minutes
