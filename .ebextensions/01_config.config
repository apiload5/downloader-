# .ebextensions/01-setup.config
option_settings:
  # Platform
  aws:elasticbeanstalk:environment:
    ServiceRole: aws-elasticbeanstalk-service-role
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx
  
  # Launch Configuration
  aws:autoscaling:launchconfiguration:
    RootVolumeType: gp3
    DisableIMDSv1: true
    RootVolumeSize: 30
    EC2KeyName: your-key-name  # Add if needed
  
  # Instance Configuration
  aws:ec2:instances:
    InstanceTypes: t3.medium
  
  # Python Configuration
  aws:elasticbeanstalk:container:python:
    WSGIPath: application.py
    NumProcesses: 1
    NumThreads: 15
  
  # Environment Variables
  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: "/var/app/current"
    PYTHONUNBUFFERED: "1"
    FFMPEG_PATH: "/usr/local/bin/ffmpeg"
    FFPROBE_PATH: "/usr/local/bin/ffprobe"
  
  # Health Check
  aws:elasticbeanstalk:application:
    Application Healthcheck URL: "/health"
  
  # Timeout Settings
  aws:elasticbeanstalk:command:
    Timeout: 3600
    IgnoreHealthCheck: false

packages:
  yum:
    git: []
    wget: []
    python3-devel: []
    gcc: []
    openssl-devel: []
    libffi-devel: []

files:
  "/tmp/install_ffmpeg.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /tmp
      wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
      tar -xf ffmpeg-release-amd64-static.tar.xz
      cd ffmpeg-*-amd64-static
      cp ffmpeg /usr/local/bin/
      cp ffprobe /usr/local/bin/
      chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe
      ln -sf /usr/local/bin/ffmpeg /usr/bin/ffmpeg
      ln -sf /usr/local/bin/ffprobe /usr/bin/ffprobe
      rm -rf /tmp/ffmpeg-*

commands:
  01_install_ffmpeg:
    command: "/bin/bash /tmp/install_ffmpeg.sh"
  
  02_create_directories:
    command: |
      mkdir -p /tmp/downloads /tmp/processing
      chmod 777 /tmp/downloads /tmp/processing
  
  03_verify_installation:
    command: |
      ffmpeg -version > /tmp/ffmpeg_version.log
      ffprobe -version >> /tmp/ffmpeg_version.log
