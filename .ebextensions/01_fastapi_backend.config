# ==========================================
# SaveMedia FastAPI Backend â€“ AWS EB Config
# Supports FFmpeg + yt-dlp installation
# ==========================================

packages:
  yum:
    git: []
    gcc: []
    gcc-c++: []
    make: []
    openssl-devel: []
    libffi-devel: []
    python3-devel: []
    wget: []
    tar: []
    xz: []
    freetype-devel: []
    fontconfig-devel: []
    nasm: []
    yasm: []
    libtheora: []
    libogg: []
    libvorbis: []
    libvpx: []

option_settings:
  aws:elasticbeanstalk:application:environment:
    PYTHONUNBUFFERED: "1"
    PYTHONDONTWRITEBYTECODE: "1"
    FFMPEG_BINARY: "/usr/local/bin/ffmpeg"
    FFPROBE_BINARY: "/usr/local/bin/ffprobe"
    YT_DLP_BINARY: "/usr/local/bin/yt-dlp"
    PORT: "8080"
    
  aws:elasticbeanstalk:container:python:
    WSGIPath: "application:application"
    
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: "/"
    Port: "8080"
    Protocol: "HTTP"

commands:
  01_update_system:
    command: "yum update -y"
    ignoreErrors: true

  02_install_epel:
    command: "amazon-linux-extras install epel -y"
    ignoreErrors: true

  03_install_pip_deps:
    command: "/var/app/venv/*/bin/pip install --upgrade pip setuptools wheel"
    ignoreErrors: true

  04_install_ffmpeg:
    command: |
      echo "=== Installing FFmpeg ==="
      cd /tmp
      wget -q --timeout=60 https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
      if [ $? -eq 0 ]; then
        tar -xf ffmpeg-release-amd64-static.tar.xz
        FOLDER=$(find . -type d -name "ffmpeg-*-amd64-static" | head -n 1)
        cp "$FOLDER/ffmpeg" /usr/local/bin/
        cp "$FOLDER/ffprobe" /usr/local/bin/
        chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe
        ln -sf /usr/local/bin/ffmpeg /usr/bin/ffmpeg
        ln -sf /usr/local/bin/ffprobe /usr/bin/ffprobe
        echo "FFmpeg Installed OK"
      else
        echo "FFmpeg download failed"
        exit 1
      fi

  05_install_yt_dlp:
    command: |
      echo "=== Installing yt-dlp ==="
      wget -q --timeout=60 https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -O /usr/local/bin/yt-dlp
      chmod +x /usr/local/bin/yt-dlp
      ln -sf /usr/local/bin/yt-dlp /usr/bin/yt-dlp
      echo "yt-dlp Installed OK"

container_commands:
  01_create_dirs:
    command: |
      mkdir -p /var/app/current/downloads
      mkdir -p /var/app/current/temp
      mkdir -p /var/log/savemedia
      chmod -R 755 /var/app/current
      chown -R webapp:webapp /var/app/current
    ignoreErrors: true

  02_verify_tools:
    command: |
      echo "=== Verifying installations ==="
      ffmpeg -version | head -1 || echo "FFmpeg missing"
      ffprobe -version | head -1 || echo "FFprobe missing"
      yt-dlp --version || echo "yt-dlp missing"
    ignoreErrors: true
